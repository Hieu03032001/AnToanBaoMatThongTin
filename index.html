<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>He ma Elgamel</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>

    <!-- link bootstrap -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <!-- style  -->
    <style>
        .container{
            background:rgb(182, 183, 182,0.5);
            border: 1px solid black;
            padding: 20px;
        }
        .row{
            margin-top: 10px;
        }
        .col-lg-4{
            border: px solid black;
            border-right: 0px;
            height: 400px;
        }
        .col-xs-6{
            margin-left: 20px;
        }
        .input{
            width: 100px; 

        }
        .text-center p{
            margin-bottom: 5px;
        }
        .button{
            text-align: center;
        }
        .allert{
            margin: -10px 0 0 65px;
            color: red;
        }
    </style>


    <!-- javascrip -->
    <script>
        // check so nguyen to
        function IsPrime(a){
            if(a < 2)
                return false;
            var s = Math.floor(Math.sqrt(a));
            for(var i = 2; i <= s;i++)
                if(a % i == 0)
                    return false;
            return true;
        }
        //mang nhi phan 1 so
        function binaryNum(a){
            var arr = [];
            while (a > 0){
                arr.push(a%2);
                a = Math.floor(a/2);
            }
            return arr;
        }
  
        //binh phuong va nhan
        function expmod(alpha, a, p){
            var arr = binaryNum(a);
            var beta = alpha%p;
            var c ;
            for(var i = arr.length-2 ; i >= 0 ; i--){
                if(arr[i] == 0){
                    c = (beta*beta) %p;
                }
                else{
                    c = (beta *beta * alpha)%p;
                }
                beta = c;
            }
            return c;
        }
        // tim modulo nghich dao
        function Inverse(b,a){
            var d,q,r,x,x1,x2,y1,y2;
            if(b == 0){
                d = a;
                x = 1;
                y = 0;
            }
            else{
                x2 =1, x1 = 0;y2 =0;y1 =1;
                while(b > 0){
                    q = Math.floor(a/b);
                    r = a - q*b;
                    x = x2 - q*x1;
                    y = y2 - q*y1;
                    a =b,b =r, x2 =x1,x1=x,y2=y1,y1 =y;
                }
                d =a; x =x2 ;y =y2; 
            }
            if(y < 0)
                y = b+ y;

            return y;
        }
   
        //chuyen mang kí tự sang mảng unicode
        function convertUni(arrInput){
            arrUni = [];
            for(var index = 0; index < arrInput.length; index++)
                arrUni.push(arrInput.charCodeAt(index));
            return arrUni;
        }
        //chuyen mang sang string
        function convertString(arrOut){
            arrString = [];
            for(var index = 0; index < arrOut.length; index++)
                arrString.push(String.fromCharCode(arrOut[index]));
            return arrString;
        }
        //hàm mã hóa
        function MaHoa(){
            var p = document.getElementById("p").value;
            var alpha = document.getElementById("alpha").value;
            var a = document.getElementById("a").value;
            var banRo = document.getElementById("maHoa_banRo").value;
            var beta = expmod(alpha,a,p);
            arrBanRoUni = convertUni(banRo);
            arrBanMa = []
            var c1, c2,k;
            for(var index = 0 ; index < arrBanRoUni.length; index ++){
                k = Math.floor(Math.random()*p +1);
                c1 = expmod(alpha, k,p);
                c2 = (arrBanRoUni[index] * expmod(beta,k,p)) %p;
                arrBanMa.push(c1,c2);
            }
            //ban ma
            var banMa = [];
            banMa = convertString(arrBanMa).join('');
            return banMa;
        }

        // ham giai ma
        function GiaiMa(){
            var p = document.getElementById("p").value;
            var a = document.getElementById("a").value;
            var c = document.getElementById("giaiMa_banMa").value;
            var arrBanMaString = convertUni(c);
            var ArrgiaiMa = [];
            for(var i = 0; i < arrBanMa.length; ){
                //var k =expmod(arrBanMa[i],a,p);
                //var m = (Inverse(k,p) *arrBanMa[i+1])%p;
                var m = (expmod(arrBanMa[i],p-1-a,p) *(arrBanMa[i+1])%p )%p;
                ArrgiaiMa.push(m);
                i+=2;
            }
            var giaiMa = convertString(ArrgiaiMa).join(''); 
            return giaiMa;
        }
        // button tao khao cong khai
        function create_key(){
            var p = document.getElementById("p").value;
            var alpha = document.getElementById("alpha").value;
            var a = document.getElementById("a").value;
            document.getElementById("beta").value = expmod(alpha,a,p);
        }
        //button ma hoa
        function button_MaHoa(){   
            var p = document.getElementById("p").value;
            var alpha = document.getElementById("alpha").value;
            var a = document.getElementById("a").value;
            //check_input();
            
            //xuat ban ma
            document.getElementById("beta").value = expmod(alpha,a,p);
            document.getElementById("maHoa_banMa").value = MaHoa();
        }

        //button giai ma
        function button_GiaiMa(){
            document.getElementById("giaiMa_banRo").innerHTML = GiaiMa() ;
        }
        // button delete
        function button_XoaBanRo(){
            document.getElementById("maHoa_banRo").value = "";
        }
        function button_XoaBanMa(){
            document.getElementById("giaiMa_banMa").value = "";
        }
        // button copy
        function copy_banMa(){
            var s = document.getElementById("maHoa_banMa").value;
            document.getElementById("giaiMa_banMa").value = s;
        }
        // check input
        function check_input(){
            var p = document.getElementById("p").value;
            var alpha = document.getElementById("alpha").value;
            var a = document.getElementById("a").value;
            var patt =/^[0-9]$/;//regex
            // check p
            if( p == ""){
                document.getElementById("allert_p").innerText = "Khong duoc bo trong";
            }
            else{
                if(patt.test("p")){
                    if(IsPrime(p) == 0){
                        document.getElementById("p").value ="";
                        document.getElementById("allert_p").innerText ="p khong la so nguyen to";
                    }
                    else
                        document.getElementById("allert_p").innerText ="";
                }
                else{
                    document.getElementById("p").value ="";
                        document.getElementById("allert_p").innerText ="nhap lai gia tri ";
                }
            }
            //check alpha
            if(alpha == ""){
                document.getElementById("allert_alpha").innerText = "Khong duoc bo trong";
            }    
        }
    </script>

</head>

<body>
    <div class="text-center">
        <p> B1 : Nhập p, alpha,beta</p>
        <p>B2 : Tao Khóa công khai</p>
        <p>B3 : Nhập Giá trị muốn giải mã || Mã hóa</p>
        <p>B4 : Giải mã || Mã Hóa</p>
    </div>


    <div class="container" >
        <div class="row">
          <div class="col-lg-4" style="border-right: 1px solid black">
            <h5>Khóa công khai:</h5>
            <div class="row">
                <div class="col-xs-6" style="width: 40px;"><p>p:</p> </div>
                <div class="col-xs-6"><input type="text" class="align-seft-sm-end" id="p" ></div>
            </div> 
            <p class="allert" id ="allert_p"></p>
            <div class="row">
                <div class="col-xs-6" style="width: 40px;"><p>Alpha:</p> </div>
                <div class="col-xs-6"><input  type="text" class="align-seft-sm-end" id="alpha" ></div>
            </div> 
            <p class="allert" id="allert_alpha"></p>
            <h5>Khóa bí mật:</h5> 
            <div class="row">
                <div class="col-xs-6" style="width: 40px;"><p>a:</p> </div>
                <div class="col-xs-6"><input type="text" class="align-seft-sm-end" id="a" ></div>
            </div>   
            <button onclick="create_key()" class="btn btn-sm btn-outline-dark" style="margin-left: 70px;">Tạo khóa công khai</button>           
            <div class="row">
                <div class="col-xs-6" style="width: 40px;"><p>Beta:</p> </div>
                <div class="col-xs-6"><input type="text" class="align-seft-sm-end" id="beta" ></div>
            </div> 
        </div>

        <div class="col-lg-4" style="border-right: 1px solid black">
            <h4>Mã Hóa</h4>
            <h5>Bản rõ</h5>
            <textarea name="" id="maHoa_banRo" cols="34" rows="5"></textarea>
            <div class="col-sm" style="margin-left: -7px;">
                <button class="btn btn-sm btn-outline-dark" onclick="button_MaHoa()" >Mã hóa</button> 
                <button class="btn btn-sm btn-outline-dark" onclick="button_XoaBanRo()">Xóa bản rõ</button> 
                <button class="btn btn-sm btn-outline-dark" onclick="copy_banMa()">Copy Bản Mã</button>
            </div>
            <h5>Bản mã</h5>
            <textarea name="" id="maHoa_banMa" cols="34" rows="5"></textarea>
        </div>
        
        <div class="col-lg-4">
            <h4>Giải mã</h4>
            <h5>Bản mã</h5>
            <textarea name="" id="giaiMa_banMa" cols="34" rows="5"></textarea>
            <div class="col-sm" style="margin-left: 60px;">
                <button class="btn btn-sm btn-outline-dark" onclick="button_GiaiMa()">Giải mã</button> 
                <button class="btn btn-sm btn-outline-dark" onclick="button_XoaBanMa()">Xóa bản mã</button> 
            </div>
            <h5>Bản rõ</h5>
            <textarea name="" id="giaiMa_banRo" cols="34" rows="5"></textarea>
        </div>
          
        </div>
      </div>
</body>
</html>